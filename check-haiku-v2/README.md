# check-haiku-v2

ここでは形態素解析を活用して、俳句の判定を実装しています。[check-haiku-v1](../check-haiku-v1)では以下のケースに対応できていなかったですが、形態素解析をすることによってそれぞれ対応できるようになっています。

- 漢字の読みを理解する
- 文章の自然な切れ目を理解する

また、単純な文字数カウントではなく音数を判定するために、「ャュョ」が含まれる場合に全体の文字数からマイナスするようにしています。例えば、
- 「集中」: ひらがなに起こすと6文字だが、「ゅ」が2回入ってるため「しゅ」「う」「ちゅ」「う」の4音として判定

## 事前準備

あらかじめ `ipadic` 配下に辞書データが生成されていることを前提としています。以下の手順で辞書データを生成してください。

1. https://github.com/sile/igo/releases/tag/0.4.5 から本体のソースコードをダウンロードします。
2. ディレクトリ移動しておきます。 i.e. `cd /path/to/igo` 
3. `brew install ant` などで `ant` を入れます。
4. `ant` を実行し、ソースコードをビルドします。 `igo-0.4.5.jar` ができます。
5. `java -cp /path/to/igo-0.4.5.jar net.reduls.igo.bin.BuildDic ipadic /path/to/mecab-ipadic-2.7.0-20070801 EUC-JP` のようなコマンドを実行し、 `ipadic` ディレクトリに辞書データを生成します。

> [!TIP]
> Igoに関する古い記事では igo-0.4.5.jar ファイルをネット上からダウンロードする案内がありますが、2025年4月現在リンク切れしていたため、GitHubから落としてきたソースコードからビルドしています。

### ちなみに: 形態素解析のために検討したライブラリ・API

以下のような手段も検討しました。

- [php-mecab](https://github.com/rsky/php-mecab)
- [Yahoo!日本語形態素解析API](https://developer.yahoo.co.jp/webapi/jlp/ma/v2/parse.html)
- [RakutenMA API](https://www.apibank.jp/ApiBank/api/detail?api_no=1028&api_type=I)
- [Google Cloud Natural Language API](https://cloud.google.com/natural-language)

どれでもよかったですが、今回はローカルで動いて上にセットアップが楽そうな igo-php (厳密にはフォークの https://github.com/logue/igo-php )を採用しています。フォークのほうはcomposerに対応しています。

## 実行方法

以下のように実行してください。

```sh
php ./check-haiku-v2.php
```

標準入力から文字列を受け取るので試したい文字列を渡してください。

## 試した結果

### :o: 小田原でみんなで一句詠みたいな

- Expected: 俳句
- Received: 俳句

漢字を含んでいても正しくパースしてくれるようになりました。

```sh
php ./check-haiku-v2.php
小田原でみんなで一句詠みたいな
上五: 小田原で (読み: オダワラデ) (5音)
中七: みんなで一句 (読み: ミンナデイック) (7音)
下五: 詠みたいな (読み: ヨミタイナ) (5音)
合計: 17音

これは俳句です。
```

### :o: おだわらでみんなでいっくよみたいな

- Expected: 俳句
- Received: 俳句

ひらがなでも問題ありません。

```sh
php ./check-haiku-v2.php
おだわらでみんなでいっくよみたいな
上五: おだわらで (読み: オダワラデ) (5音)
中七: みんなでいっく (読み: ミンナデイック) (7音)
下五: よみたいな (読み: ヨミタイナ) (5音)
合計: 17音

これは俳句です。
```

### :o: 十七文字の文章を作る

- Expected: Not 俳句
- Received: Not 俳句

17文字であってもちゃんと15音と判定している。

```sh
php ./check-haiku-v2.php
十七文字の文章を作る
上五: 十七文字 (読み: ジューシチモジ) (6音)
中七: の文章を作る (読み: ノブンショーヲツクル) (9音)
下五:  (読み: ) (0音)
合計: 15音

これは俳句ではありません。
```

### :o: 文字数的に合っててもダメだよね

- Expected: Not 俳句
- Received: Not 俳句

文章の切れ目を理解した上で5-7-5になっていないことを判定できている。

```sh
php ./check-haiku-v2.php
文字数的に合っててもダメだよね
上五: 文字数的 (読み: モジスーテキ) (6音)
中七: に合っててもダメ (読み: ニアッテテモダメ) (8音)
下五: だよね (読み: ダヨネ) (3音)
合計: 17音

これは俳句ではありません。
```

### :o: 使いたいPHP判定に

- Expected: 俳句
- Received: 俳句

「PHP」という単語に限って発音をハードコードしているので、ちゃんと判定できています。

```sh
php ./check-haiku-v2.php
使いたいPHP判定に
上五: 使いたい (読み: ツカイタイ) (5音)
中七: PHP (読み: ピーエイチピー) (7音)
下五: 判定に (読み: ハンテイニ) (5音)
合計: 17音

これは俳句です。
```
